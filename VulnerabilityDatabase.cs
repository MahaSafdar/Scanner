using System;
using System.Net.Http;
using System.Text.Json;
using System.Threading.Tasks;
using System.Collections.Generic;
using PortScanner.Scanners.Common;
using System.Linq;
using System.Threading;

namespace PortScanner.Scanners
{
    public class VulnerabilityDatabase
    {
        private readonly HttpClient _client;
        private const string NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0";
        private const int MAX_RETRIES = 3;
        private const int RETRY_DELAY_MS = 2000;
        private const string NVD_API_KEY = "05473b7a-2b84-45bc-9caf-08a7016c30a0";
        private static readonly SemaphoreSlim _rateLimiter = new SemaphoreSlim(1, 1);
        private static DateTime _lastRequestTime = DateTime.MinValue;

        public VulnerabilityDatabase()
        {
            _client = new HttpClient();
            _client.Timeout = TimeSpan.FromSeconds(30);
            _client.DefaultRequestHeaders.Add("User-Agent", "Port Scanner/1.0");
            _client.DefaultRequestHeaders.Add("apiKey", NVD_API_KEY);
        }

        public async Task<List<VulnerabilityInfo>> GetVulnerabilities(string service, string version)
        {
            if (string.IsNullOrWhiteSpace(service) || string.IsNullOrWhiteSpace(version))
            {
                return new List<VulnerabilityInfo>();
            }

            int retryCount = 0;
            while (retryCount < MAX_RETRIES)
            {
                try
                {
                    await _rateLimiter.WaitAsync();
                    try
                    {
                        var timeSinceLastRequest = DateTime.UtcNow - _lastRequestTime;
                        if (timeSinceLastRequest.TotalMilliseconds < 600)
                        {
                            await Task.Delay(600 - (int)timeSinceLastRequest.TotalMilliseconds);
                        }

                        string query = $"{service} {version}";
                        string url = $"{NVD_API_URL}?keywordSearch={Uri.EscapeDataString(query)}&resultsPerPage=50";

                        using var request = new HttpRequestMessage(HttpMethod.Get, url);
                        request.Headers.Add("apiKey", NVD_API_KEY);

                        using var response = await _client.SendAsync(request);
                        _lastRequestTime = DateTime.UtcNow;

                        switch (response.StatusCode)
                        {
                            case System.Net.HttpStatusCode.OK:
                                var jsonResponse = await response.Content.ReadAsStringAsync();
                                return ParseVulnerabilities(jsonResponse, service);

                            case System.Net.HttpStatusCode.Unauthorized:
                                Console.WriteLine("\nInvalid or missing API key.");
                                break;

                            case System.Net.HttpStatusCode.TooManyRequests:
                                if (retryCount < MAX_RETRIES - 1)
                                {
                                    await Task.Delay(RETRY_DELAY_MS * (retryCount + 2));
                                    retryCount++;
                                    continue;
                                }
                                Console.WriteLine("\nRate limit exceeded.");
                                break;

                            case System.Net.HttpStatusCode.ServiceUnavailable:
                                if (retryCount < MAX_RETRIES - 1)
                                {
                                    await Task.Delay(RETRY_DELAY_MS * (retryCount + 1));
                                    retryCount++;
                                    continue;
                                }
                                Console.WriteLine("\nNVD API is currently unavailable.");
                                break;

                            case System.Net.HttpStatusCode.Forbidden:
                                Console.WriteLine("\nAccess to NVD API is restricted.");
                                break;

                            default:
                                Console.WriteLine($"\nUnexpected response from NVD API: {response.StatusCode}");
                                break;
                        }
                    }
                    finally
                    {
                        _rateLimiter.Release();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"\nError accessing NVD API: {ex.Message}");
                    if (retryCount < MAX_RETRIES - 1)
                    {
                        await Task.Delay(RETRY_DELAY_MS * (retryCount + 1));
                        retryCount++;
                        continue;
                    }
                }
            }

            return new List<VulnerabilityInfo>();
        }

        private List<VulnerabilityInfo> ParseVulnerabilities(string jsonResponse, string service)
        {
            var vulnerabilities = new List<VulnerabilityInfo>();
            try
            {
                using var jsonDoc = JsonDocument.Parse(jsonResponse);
                var vulns = jsonDoc.RootElement.GetProperty("vulnerabilities").EnumerateArray();

                foreach (var vuln in vulns)
                {
                    var cve = vuln.GetProperty("cve");
                    var desc = cve.GetProperty("descriptions").EnumerateArray()
                        .FirstOrDefault(d => d.GetProperty("lang").GetString() == "en")
                        .GetProperty("value").GetString();

                    var metrics = cve.GetProperty("metrics");
                    var severity = "Medium"; // Default severity

                    if (metrics.TryGetProperty("cvssMetricV31", out var cvssV31) &&
                        cvssV31.GetArrayLength() > 0)
                    {
                        var cvssData = cvssV31[0].GetProperty("cvssData");
                        var baseScore = cvssData.GetProperty("baseScore").GetDouble();
                        severity = baseScore switch
                        {
                            >= 9.0 => "Critical",
                            >= 7.0 => "High",
                            >= 4.0 => "Medium",
                            _ => "Low"
                        };
                    }

                    vulnerabilities.Add(new VulnerabilityInfo
                    {
                        Name = $"CVE Vulnerability in {service}",
                        Description = desc,
                        Severity = severity,
                        CVE = cve.GetProperty("id").GetString(),
                        Recommendation = $"Update {service} to latest version and apply security patches"
                    });
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error parsing vulnerabilities: {ex.Message}");
            }

            return vulnerabilities;
        }
    }
}